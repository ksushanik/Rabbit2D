# Система ям в Rabbit2D

## Описание
Ямы - это новая игровая механика, которая добавляет дополнительную сложность в игру. Если кролик попадает в яму, он проваливается и игра предлагает игроку выбор: перезапустить уровень или выйти из игры.

## Технические детали

### Размещение ям
- Ямы размещаются на любом слое TileMap через **Custom Data Layers**
- Используются альтернативные тайлы из основного тайлсета (позиция 7,8)
- Ямы имеют custom_data `type = "pit"` в Custom Data Layer 0

### Логика работы

#### 1. Обнаружение ям
- Функция `is_pit(grid_pos: Vector2i)` проверяет, является ли клетка ямой
- Проверка происходит на всех слоях TileMap
- Возвращает `true`, если любой тайл имеет `custom_data["type"] == "pit"`

#### 2. Расчет движения
- В функции `calculate_slide_destination()` добавлена проверка на ямы
- Если кролик попадает в яму, движение останавливается НА яме (не перед ней)
- Устанавливается флаг `hit_pit = true` в результате расчета

#### 3. Обработка падения
- В `_on_rabbit_move_finished()` проверяется флаг `hit_pit`
- При падении в яму:
  1. Определяется направление движения кролика
  2. Запускается соответствующая анимация падения (`fall_into_pit_[direction]`)
  3. Показывается диалог выбора действий

#### 4. Анимации падения
Доступны анимации для всех направлений:
- `fall_into_pit_up` - падение при движении вверх
- `fall_into_pit_down` - падение при движении вниз  
- `fall_into_pit_left` - падение при движении влево
- `fall_into_pit_right` - падение при движении вправо

### Диалог выбора действий

После падения в яму показывается диалог с опциями:
- **"Перезапустить уровень"** - перезагружает текущий уровень
- **"Выйти из игры"** - закрывает игру

Функции обработки:
- `_show_pit_fall_dialog()` - создает и показывает диалог
- `_on_pit_dialog_action(action: String)` - обрабатывает выбор пользователя
- `_on_pit_dialog_restart()` - обрабатывает нажатие кнопки OK

## Добавление ям в уровни

### В редакторе Godot:
1. Откройте сцену уровня (например, `level_8.tscn`)
2. Выберите узел `Ground` (TileMap)
3. Переключитесь на слой "Obstacles" (слой 1)
4. Выберите источник тайлов "holes" (источник 1)
5. Разместите ямы в нужных позициях

### Программно:
Добавьте данные тайлов в `layer_X/tile_data`:
```
layer_1/tile_data = PackedInt32Array(196612, 458752, 1)
```
Где:
- `196612` - позиция тайла (grid_pos.y * 65536 + grid_pos.x)
- `458752` - atlas_coords (7,8) для тайла с ямами
- `1` - alternative_tile (1 или 2 для разных вариантов ям)

## Тестирование

Для тестирования системы ям:
1. Запустите уровень 8, где добавлена тестовая яма
2. Переместите кролика в позицию (4,3) - там находится яма
3. Проверьте, что:
   - Кролик останавливается на яме
   - Запускается анимация падения
   - Показывается диалог выбора
   - Кнопки работают корректно

## Файлы, затронутые изменениями

### Основные файлы:
- `scripts/Level.gd` - основная логика обработки ям
- `assets/tilemap/new_world.tres` - добавлен источник тайлов ям
- `scenes/level_8.tscn` - тестовый уровень с ямой

### Новые функции в Level.gd:
- `is_pit(grid_pos: Vector2i)` - проверка на яму
- `_show_pit_fall_dialog()` - показ диалога
- `_on_pit_dialog_action(action: String)` - обработка выбора
- `_on_pit_dialog_restart()` - обработка перезапуска

### Изменения в существующих функциях:
- `calculate_slide_destination()` - добавлена проверка ям
- `_on_rabbit_move_finished()` - добавлена обработка падения в яму

## Совместимость

Система ям полностью совместима с существующими механиками:
- Морковки не проваливаются в ямы (только кролик)
- Ямы не блокируют движение морковок
- Заборы и стены работают как обычно
- Система выходов не затронута

## Возможные улучшения

1. **Звуковые эффекты**: Добавить звук падения в яму
2. **Визуальные эффекты**: Частицы или дополнительная анимация
3. **Разные типы ям**: Ямы с разными эффектами
4. **Статистика**: Подсчет количества падений в ямы
5. **Настройки**: Возможность отключить диалог и сразу перезапускать 