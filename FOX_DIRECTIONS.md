# Система лис с 4 направлениями

## Обзор
Система лис была расширена для поддержки 4 направлений: влево, вправо, вверх и вниз. Каждая лиса создает опасную зону в направлении своего взгляда.

## Готовые сцены лис

### 1. FoxLeft (scenes/fox_left.tscn)
- **Направление**: Влево (Vector2i(-1, 0))
- **Опасная зона**: Слева от лисы
- **Анимация**: idle_left, attack_left
- **Использование**: Когда нужна опасная зона слева

### 2. FoxRight (scenes/fox_right.tscn)
- **Направление**: Вправо (Vector2i(1, 0))
- **Опасная зона**: Справа от лисы
- **Анимация**: idle_right, attack_right
- **Использование**: Когда нужна опасная зона справа

### 3. FoxUp (scenes/fox_up.tscn)
- **Направление**: Вверх (Vector2i(0, -1))
- **Опасная зона**: Сверху от лисы
- **Анимация**: idle_up, attack_up
- **Использование**: Когда нужна опасная зона сверху

### 4. FoxDown (scenes/fox_down.tscn)
- **Направление**: Вниз (Vector2i(0, 1))
- **Опасная зона**: Снизу от лисы
- **Анимация**: idle_down, attack_down
- **Использование**: Когда нужна опасная зона снизу

## Как добавить лису в уровень

### Способ 1: Через редактор Godot
1. Откройте сцену уровня
2. Нажмите "+" для добавления узла
3. Выберите "Instance" и найдите нужную сцену лисы:
   - `scenes/fox_left.tscn` - для лисы влево
   - `scenes/fox_right.tscn` - для лисы вправо
   - `scenes/fox_up.tscn` - для лисы вверх
   - `scenes/fox_down.tscn` - для лисы вниз
4. Установите позицию лисы в мировых координатах
5. Сохраните сцену

### Способ 2: Программно в .tscn файле
```gdscript
# Добавьте в секцию ext_resource:
[ext_resource type="PackedScene" uid="uid://fox_right_scene" path="res://scenes/fox_right.tscn" id="6_fox"]

# Добавьте узел лисы:
[node name="FoxRight" parent="." instance=ExtResource("6_fox")]
z_index = 5
position = Vector2(112, 144)  # Мировые координаты
```

## Расчет координат

### Мировые координаты
- **Формула**: `Vector2(grid_x * 32 + 16, grid_y * 32 + 16)`
- **Пример**: Клетка (3,4) = Vector2(112, 144)

### Опасные зоны
Опасная зона автоматически рассчитывается в направлении взгляда лисы:
- **FoxLeft**: опасная зона в клетке (grid_x - 1, grid_y)
- **FoxRight**: опасная зона в клетке (grid_x + 1, grid_y)
- **FoxUp**: опасная зона в клетке (grid_x, grid_y - 1)
- **FoxDown**: опасная зона в клетке (grid_x, grid_y + 1)

## Анимации

### Структура анимаций
Каждое направление имеет 2 типа анимаций:
- **idle_[direction]**: Анимация ожидания (зацикленная)
- **attack_[direction]**: Анимация атаки (одноразовая)

### Спрайты
- `lisa-Sheet.png` - лиса влево
- `lisa2-Sheet.png` - лиса вправо  
- `lisa3-Sheet.png` - лиса вниз
- `lisa4-Sheet.png` - лиса вверх

## Игровая механика

### Лиса как препятствие
- **Физическое препятствие**: Лиса блокирует движение кролика и морковок
- **Нельзя проходить через лису**: Кролик и морковки останавливаются перед лисой
- **Опасная зона**: Дополнительно к физическому блокированию, лиса создает опасную зону

### Безопасное прохождение опасной зоны
Кролик может безопасно проходить через опасную зону, если не останавливается в ней.

### Смерть от лисы
Кролик умирает, если останавливается в опасной зоне лисы. При этом:
1. Лиса воспроизводит анимацию атаки в своем направлении
2. Кролик воспроизводит анимацию смерти (если есть)
3. Ожидание 1.5 секунды для завершения анимаций
4. Показывается диалог с выбором: перезапуск или выход

### Падение в яму
Аналогично смерти от лисы, падение в яму также имеет задержку:
1. Кролик воспроизводит анимацию падения в яму
2. Ожидание 1.0 секунды для завершения анимации
3. Показывается диалог с выбором: перезапуск или выход

### Приоритет проверок
1. Сначала проверяются ямы (pits)
2. Затем проверяются опасные зоны лис
3. Последними проверяются морковки и выходы

## Примеры использования

### Level 10
```gdscript
# Лиса справа на позиции (3,4), опасная зона на (4,4)
[node name="FoxRight" parent="." instance=ExtResource("6_fox")]
position = Vector2(112, 144)
```

### Создание сложных паттернов
Можно комбинировать лис разных направлений для создания сложных головоломок:
- Лиса влево + лиса вправо = коридор с опасностью с обеих сторон
- Лиса вверх + лиса вниз = вертикальный коридор опасности
- Четыре лисы вокруг одной клетки = полностью заблокированная область

## Техническая реализация

### Класс Fox
- **fox_direction**: Vector2i - направление взгляда лисы
- **danger_zone_pos**: Vector2i - позиция опасной зоны
- **_get_direction_name()**: возвращает строку направления для анимаций
- **_calculate_danger_zone()**: вычисляет позицию опасной зоны

### Интеграция с Level
- Лисы автоматически находятся и инициализируются в `_ready()`
- Проверка опасных зон происходит в `_on_rabbit_move_finished()`
- Поддерживается массив `active_foxes` для отслеживания всех лис на уровне
- **Важно**: Лисы НЕ имеют сигнала `move_finished` (в отличие от кроликов и морковок)

### Исправленные проблемы
- **Ошибка "Invalid access to property or key 'move_finished'"**: Исправлена путем добавления проверки `not carrot_node is Fox` в инициализации морковок
- **UID конфликты**: Исправлены путем унификации UID в `fox_animations.tres`
- **Кролик проходил через лису**: Исправлено добавлением проверки лис в `calculate_slide_destination()` и функциях проверки свободности клеток

### Отладка
Для отладки создан тестовый уровень `scenes/test_fox_level.tscn` с простой конфигурацией:
- Кролик в позиции (1,1)
- Морковка в позиции (4,1)  
- Лиса вправо в позиции (3,1) - блокирует путь к морковке и создает опасную зону в (4,1)

**Тест механики**: Кролик не может пройти через лису к морковке. Если кролик попытается двигаться вправо, он остановится перед лисой в позиции (2,1). 